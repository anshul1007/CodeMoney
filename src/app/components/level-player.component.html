<div
  class="min-h-screen bg-gradient-to-br from-yellow-100 via-orange-50 to-red-100"
  *ngIf="currentLevel"
>
  <!-- Header -->
  <div class="bg-white shadow-sm border-b-4 border-yellow-400 p-3 sm:p-4">
    <div
      class="max-w-4xl mx-auto flex items-center justify-between flex-wrap gap-2"
    >
      <div class="flex items-center space-x-3 sm:space-x-4 flex-1 min-w-0">
        <button
          (click)="goBack()"
          class="text-gray-600 hover:text-gray-800 text-xl sm:text-2xl flex-shrink-0"
        >
          ‚Üê Back
        </button>
        <div class="min-w-0 flex-1">
          <h1 class="text-lg sm:text-xl font-bold text-gray-800 truncate">
            {{ currentLevel.title }}
          </h1>
          <p class="text-xs sm:text-sm text-gray-600 line-clamp-2">
            {{ currentLevel.description }}
          </p>
        </div>
      </div>
      <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
        <span
          *ngFor="let star of getStarsArray(currentLevel.stars)"
          class="text-yellow-400 text-lg sm:text-xl"
          >‚≠ê</span
        >
      </div>
    </div>
  </div>

  <!-- Game Content -->
  <div class="max-w-4xl mx-auto p-3 sm:p-4 md:p-6">
    <!-- Scene Description -->
    <div
      *ngIf="currentLevel.gameData.scene"
      class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 text-center"
    >
      <div class="text-4xl sm:text-5xl md:text-6xl mb-3 sm:mb-4">üè™</div>
      <p class="text-base sm:text-lg text-gray-700">
        {{ currentLevel.gameData.scene }}
      </p>
    </div>

    <!-- Game Prompt -->
    <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
      <h2
        class="text-xl sm:text-2xl font-bold text-center text-gray-800 mb-3 sm:mb-4"
      >
        {{ currentLevel.gameData.prompt }}
      </h2>

      <!-- Hints -->
      <div
        *ngIf="showHints && currentLevel.gameData.hints"
        class="bg-blue-50 border-l-4 border-blue-400 p-3 sm:p-4 mb-3 sm:mb-4"
      >
        <div class="flex items-center mb-2">
          <span class="text-blue-600 mr-2">üí°</span>
          <span class="font-medium text-blue-800 text-sm sm:text-base"
            >Hints:</span
          >
        </div>
        <ul class="text-blue-700 text-xs sm:text-sm space-y-1">
          <li *ngFor="let hint of currentLevel.gameData.hints">‚Ä¢ {{ hint }}</li>
        </ul>
      </div>
    </div>

    <!-- Selection Game (Level 1) -->
    <div *ngIf="currentLevel.type === 'selection'" class="game-content">
      <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
        <h3
          class="text-base sm:text-lg font-bold text-gray-800 mb-3 sm:mb-4 text-center"
        >
          Click on the items you need for your lemonade stand:
        </h3>

        <div
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3 md:gap-4"
        >
          <div
            *ngFor="let item of gameItems"
            class="item-card cursor-pointer transition-all duration-200 hover:scale-105"
            [class.selected]="item.isSelected"
            [class.correct]="item.isSelected && item.isCorrect && gameSubmitted"
            [class.incorrect]="
              item.isSelected && !item.isCorrect && gameSubmitted
            "
            (click)="toggleItemSelection(item)"
          >
            <div
              class="border-2 rounded-xl p-2 sm:p-3 md:p-4 text-center"
              [ngClass]="{
                'border-blue-500 bg-blue-50': item.isSelected && !gameSubmitted,
                'border-green-500 bg-green-50':
                  item.isSelected && item.isCorrect && gameSubmitted,
                'border-red-500 bg-red-50':
                  item.isSelected && !item.isCorrect && gameSubmitted,
                'border-gray-200 bg-white hover:border-gray-300':
                  !item.isSelected,
              }"
            >
              <div class="text-2xl sm:text-3xl md:text-4xl mb-1 sm:mb-2">
                {{ item.icon }}
              </div>
              <div class="font-medium text-xs sm:text-sm text-gray-800">
                {{ item.name }}
              </div>

              <!-- Feedback -->
              <div
                *ngIf="gameSubmitted && item.isSelected"
                class="mt-1 sm:mt-2 text-xs"
              >
                <span *ngIf="item.isCorrect" class="text-green-600"
                  >‚úÖ Great choice!</span
                >
                <span *ngIf="!item.isCorrect" class="text-red-600"
                  >‚ùå Oops! You don't need that for lemonade!</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estimation Game (Level 2) -->
    <div *ngIf="currentLevel.type === 'estimation'" class="game-content">
      <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
        <h3
          class="text-base sm:text-lg font-bold text-gray-800 mb-4 sm:mb-6 text-center"
        >
          Estimate how much each item costs:
        </h3>

        <div class="space-y-3 sm:space-y-4">
          <div
            *ngFor="let field of estimationFields"
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 sm:p-4 border border-gray-200 rounded-lg gap-2 sm:gap-4"
          >
            <div class="flex items-center space-x-2 sm:space-x-3">
              <span class="text-2xl sm:text-3xl">{{ field.icon }}</span>
              <span class="font-medium text-gray-800 text-sm sm:text-base">{{
                field.itemName
              }}</span>
            </div>

            <div class="flex items-center space-x-2 w-full sm:w-auto">
              <span class="text-base sm:text-lg">{{ field.currency }}</span>
              <input
                type="number"
                [(ngModel)]="field.userEstimate"
                placeholder="0"
                class="w-20 sm:w-24 px-2 sm:px-3 py-1 sm:py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                [disabled]="gameSubmitted"
              />

              <!-- Show actual cost after submission -->
              <div
                *ngIf="gameSubmitted"
                class="ml-2 sm:ml-4 text-xs sm:text-sm"
              >
                <div class="text-gray-600">
                  Actual: {{ field.currency }}{{ field.actualCost }}
                </div>
                <div
                  [ngClass]="{
                    'text-green-600': getEstimationAccuracy(field) >= 80,
                    'text-yellow-600': getEstimationAccuracy(field) >= 50,
                    'text-red-600': getEstimationAccuracy(field) < 50,
                  }"
                >
                  {{ getEstimationAccuracy(field) }}% accurate
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Cost -->
        <div class="mt-4 sm:mt-6 p-3 sm:p-4 bg-gray-50 rounded-lg">
          <div
            class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2"
          >
            <span class="font-bold text-base sm:text-lg text-gray-800"
              >Total Cost:</span
            >
            <span class="font-bold text-lg sm:text-xl text-blue-600">
              {{
                getTotalEstimatedCost() > 0
                  ? "‚Çπ" + getTotalEstimatedCost()
                  : "‚Çπ ---"
              }}
            </span>
          </div>
          <div
            *ngIf="gameSubmitted"
            class="text-right text-xs sm:text-sm text-gray-600 mt-1"
          >
            Actual Total: ‚Çπ{{ getTotalActualCost() }}
          </div>
        </div>
      </div>
    </div>

    <!-- Funding Game (Level 3) -->
    <div *ngIf="currentLevel.type === 'funding'" class="game-content">
      <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
        <h3
          class="text-base sm:text-lg font-bold text-gray-800 mb-4 sm:mb-6 text-center"
        >
          How will you get the money you need?
        </h3>

        <div
          class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6"
        >
          <div
            *ngFor="let source of fundingSources"
            class="funding-option cursor-pointer transition-all duration-200 hover:shadow-md"
            [class.selected]="source.isSelected"
            (click)="toggleFundingSource(source)"
          >
            <div
              class="border-2 rounded-xl p-3 sm:p-4"
              [ngClass]="{
                'border-blue-500 bg-blue-50': source.isSelected,
                'border-gray-200 bg-white hover:border-gray-300':
                  !source.isSelected,
              }"
            >
              <div class="flex items-start space-x-2 sm:space-x-3 mb-2 sm:mb-3">
                <span class="text-2xl sm:text-3xl">{{ source.icon }}</span>
                <div class="flex-1 min-w-0">
                  <h4 class="font-bold text-gray-800 text-sm sm:text-base">
                    {{ source.name }}
                  </h4>
                  <p class="text-xs sm:text-sm text-gray-600 break-words">
                    {{ source.description }}
                  </p>
                </div>
              </div>

              <!-- Amount Input -->
              <div
                *ngIf="source.isSelected && source.maxAmount! > 0"
                class="mt-2 sm:mt-3"
              >
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 mb-1"
                >
                  Amount (Max: ‚Çπ{{ source.maxAmount }}):
                </label>
                <input
                  type="number"
                  [(ngModel)]="source.amount"
                  [max]="source.maxAmount || 0"
                  placeholder="0"
                  class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Funding Summary -->
        <div class="bg-gray-50 rounded-lg p-3 sm:p-4">
          <h4 class="font-bold text-gray-800 mb-2 text-sm sm:text-base">
            Funding Summary:
          </h4>
          <div class="space-y-1 text-xs sm:text-sm">
            <div
              *ngFor="let source of getSelectedFundingSources()"
              class="flex justify-between"
            >
              <span class="truncate pr-2">{{ source.name }}</span>
              <span class="font-medium">‚Çπ{{ source.amount || 0 }}</span>
            </div>
            <div class="border-t pt-2 mt-2 flex justify-between font-bold">
              <span>Total Available:</span>
              <span class="text-green-600">‚Çπ{{ getTotalFunding() }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Validation Message for Selection Game -->
    <div
      *ngIf="
        currentLevel.type === 'selection' &&
        !gameSubmitted &&
        getSelectedItemsCount() < 2
      "
      class="mb-4 sm:mb-6 p-3 sm:p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-center max-w-md mx-auto"
    >
      <div class="flex items-center justify-center mb-2">
        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
        <span class="font-medium text-yellow-800 text-sm sm:text-base">
          Please select at least 2 items
        </span>
      </div>
      <p class="text-xs sm:text-sm text-yellow-700">
        You need to choose a minimum of 2 items for your lemonade stand to
        continue.
      </p>
    </div>

    <!-- Action Buttons -->
    <div
      class="text-center space-y-3 sm:space-y-0 sm:space-x-4 flex flex-col sm:flex-row justify-center"
    >
      <button
        *ngIf="!gameSubmitted"
        (click)="submitAnswer()"
        [disabled]="
          currentLevel.type === 'selection' && getSelectedItemsCount() < 2
        "
        class="font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 text-base sm:text-lg w-full sm:w-auto"
        [ngClass]="{
          'bg-blue-500 hover:bg-blue-600 text-white hover:shadow-lg': !(
            currentLevel.type === 'selection' && getSelectedItemsCount() < 2
          ),
          'bg-gray-300 text-gray-500 cursor-not-allowed':
            currentLevel.type === 'selection' && getSelectedItemsCount() < 2,
        }"
      >
        Submit Answer
      </button>

      <button
        *ngIf="
          !gameSubmitted && !showHints && currentLevel.gameData.hints?.length
        "
        (click)="showHints = true"
        class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 hover:shadow-lg text-base sm:text-lg w-full sm:w-auto"
      >
        üí° Show Hints
      </button>

      <button
        *ngIf="gameSubmitted"
        (click)="nextLevel()"
        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 hover:shadow-lg text-base sm:text-lg w-full sm:w-auto"
      >
        {{ isLastLevel ? "Complete Lesson" : "Next Level" }} ‚Üí
      </button>
    </div>

    <!-- Celebration Message -->
    <div
      *ngIf="gameSubmitted && lastScore > 0"
      class="mt-4 sm:mt-6 bg-green-50 border border-green-200 rounded-2xl p-4 sm:p-6 text-center"
    >
      <div class="text-3xl sm:text-4xl mb-2">üéâ</div>
      <h3 class="text-lg sm:text-xl font-bold text-green-800 mb-2">
        Great Job!
      </h3>
      <p class="text-sm sm:text-base text-green-700 mb-3">
        You earned {{ lastScore }} stars!
      </p>
      <div class="flex justify-center space-x-1">
        <span
          *ngFor="let star of getStarsArray(lastScore)"
          class="text-yellow-400 text-xl sm:text-2xl"
          >‚≠ê</span
        >
      </div>
    </div>
  </div>
</div>
