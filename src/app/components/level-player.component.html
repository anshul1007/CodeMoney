<div
  class="min-h-screen bg-gradient-to-br from-yellow-100 via-orange-50 to-red-100"
  *ngIf="currentLevel"
>
  <!-- Header -->
  <div class="bg-white shadow-sm border-b-4 border-yellow-400 p-3 sm:p-4">
    <div
      class="max-w-4xl mx-auto flex items-center justify-between flex-wrap gap-2"
    >
      <div class="flex items-center space-x-3 sm:space-x-4 flex-1 min-w-0">
        <button
          (click)="goBack()"
          class="text-gray-600 hover:text-gray-800 text-xl sm:text-2xl flex-shrink-0"
        >
          ‚Üê Back
        </button>
        <div class="min-w-0 flex-1">
          <h1 class="text-lg sm:text-xl font-bold text-gray-800 truncate">
            {{ currentLevel.title }}
          </h1>
          <p class="text-xs sm:text-sm text-gray-600 line-clamp-2">
            {{ currentLevel.description }}
          </p>
        </div>
      </div>
      <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
        <span
          *ngFor="let star of getStarsArray(currentLevel.stars)"
          class="text-yellow-400 text-lg sm:text-xl"
          >‚≠ê</span
        >
      </div>
    </div>
  </div>

  <!-- Game Content -->
  <div class="max-w-4xl mx-auto p-3 sm:p-4 md:p-6">
    <!-- Scene Description -->
    <div
      *ngIf="currentLevel.gameData.scene"
      class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 text-center"
    >
      <div class="text-4xl sm:text-5xl md:text-6xl mb-3 sm:mb-4">üè™</div>
      <p class="text-base sm:text-lg text-gray-700">
        {{ currentLevel.gameData.scene }}
      </p>
    </div>

    <!-- Game Prompt -->
    <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
      <h2
        class="text-xl sm:text-2xl font-bold text-center text-gray-800 mb-3 sm:mb-4"
      >
        {{ currentLevel.gameData.prompt }}
      </h2>

      <!-- Hints -->
      <div
        *ngIf="showHints && currentLevel.gameData.hints"
        class="bg-blue-50 border-l-4 border-blue-400 p-3 sm:p-4 mb-3 sm:mb-4"
      >
        <div class="flex items-center mb-2">
          <span class="text-blue-600 mr-2">üí°</span>
          <span class="font-medium text-blue-800 text-sm sm:text-base"
            >Hints:</span
          >
        </div>
        <ul class="text-blue-700 text-xs sm:text-sm space-y-1">
          <li *ngFor="let hint of currentLevel.gameData.hints">‚Ä¢ {{ hint }}</li>
        </ul>
      </div>
    </div>

    <!-- Selection Game (Level 1) -->
    <div *ngIf="currentLevel.type === 'selection'" class="game-content">
      <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
        <h3
          class="text-base sm:text-lg font-bold text-gray-800 mb-3 sm:mb-4 text-center"
        >
          Guess which items you need for your lemonade stand:
        </h3>

        <div
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3 md:gap-4"
        >
          <div
            *ngFor="let item of gameItems"
            class="item-card cursor-pointer transition-all duration-200 hover:scale-105"
            [class.selected]="item.isSelected"
            [class.correct]="item.isSelected && item.isCorrect && gameSubmitted"
            [class.incorrect]="
              item.isSelected && !item.isCorrect && gameSubmitted
            "
            (click)="toggleItemSelection(item)"
          >
            <div
              class="border-2 rounded-xl p-2 sm:p-3 md:p-4 text-center"
              [ngClass]="{
                'border-blue-500 bg-blue-50': item.isSelected && !gameSubmitted,
                'border-green-500 bg-green-50':
                  (item.isSelected && item.isCorrect) ||
                  (item.isCorrect && gameSubmitted),
                'border-red-500 bg-red-50':
                  item.isSelected && !item.isCorrect && gameSubmitted,
                'border-gray-200 bg-white hover:border-gray-300':
                  !item.isSelected && !gameSubmitted,
              }"
            >
              <div class="text-2xl sm:text-3xl md:text-4xl mb-1 sm:mb-2">
                {{ item.icon }}
              </div>
              <div class="font-medium text-xs sm:text-sm text-gray-800">
                {{ item.name }}
              </div>

              <!-- Feedback -->
              <div *ngIf="gameSubmitted" class="mt-1 sm:mt-2 text-xs">
                <span
                  *ngIf="item.isCorrect && item.isSelected"
                  class="text-green-600"
                  >‚úÖ Needed for lemonade!</span
                >
                <span
                  *ngIf="item.isCorrect && !item.isSelected"
                  class="text-orange-600"
                  >‚ö†Ô∏è You may need this for lemonade!</span
                >
                <span
                  *ngIf="!item.isCorrect && item.isSelected"
                  class="text-red-600"
                  >‚ùå Not needed for lemonade!</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estimation Game (Level 2) -->
    <div *ngIf="currentLevel.type === 'estimation'" class="game-content">
      <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
        <h3
          class="text-base sm:text-lg font-bold text-gray-800 mb-4 sm:mb-6 text-center"
        >
          Estimate how much each item costs:
        </h3>

        <div class="space-y-3 sm:space-y-4">
          <div
            *ngFor="let field of estimationFields"
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 sm:p-4 border border-gray-200 rounded-lg gap-2 sm:gap-4"
          >
            <div class="flex items-center space-x-2 sm:space-x-3">
              <span class="text-2xl sm:text-3xl">{{ field.icon }}</span>
              <span class="font-medium text-gray-800 text-sm sm:text-base">{{
                field.itemName
              }}</span>
            </div>

            <div class="flex items-center space-x-2 w-full sm:w-auto">
              <span class="text-base sm:text-lg">{{ field.currency }}</span>
              <input
                type="number"
                [(ngModel)]="field.userEstimate"
                placeholder="0"
                min="0"
                class="w-20 sm:w-24 px-2 sm:px-3 py-1 sm:py-2 rounded-lg text-center text-sm sm:text-base"
                [ngClass]="{
                  'border-2 border-green-500':
                    !gameSubmitted &&
                    field.userEstimate !== undefined &&
                    field.userEstimate > 0,
                  'border border-gray-300':
                    gameSubmitted ||
                    field.userEstimate === undefined ||
                    field.userEstimate <= 0,
                  'focus:ring-2 focus:ring-blue-500 focus:border-blue-500': true,
                }"
                [disabled]="gameSubmitted"
                (input)="validatePositiveValue($event)"
              />

              <!-- Empty space for consistent layout after submission -->
              <div *ngIf="gameSubmitted" class="ml-2 sm:ml-4"></div>
            </div>
          </div>
        </div>

        <!-- Total Cost -->
        <div class="mt-4 sm:mt-6 p-3 sm:p-4 bg-gray-50 rounded-lg">
          <div
            class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2"
          >
            <span class="font-bold text-base sm:text-lg text-gray-800"
              >Total Cost:</span
            >
            <span class="font-bold text-lg sm:text-xl text-blue-600">
              {{
                getTotalEstimatedCost() > 0
                  ? "‚Çπ" + getTotalEstimatedCost()
                  : "‚Çπ ---"
              }}
            </span>
          </div>
          <!-- Removed actual total section -->
        </div>
      </div>
    </div>

    <!-- Funding Game (Level 3) -->
    <div *ngIf="currentLevel.type === 'funding'" class="game-content">
      <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
        <h3
          class="text-base sm:text-lg font-bold text-gray-800 mb-2 sm:mb-3 text-center"
        >
          How will you get the money you need?
        </h3>

        <!-- Display estimated cost from previous level -->
        <div class="text-center mb-4 sm:mb-6 p-2 sm:p-3 bg-blue-50 rounded-lg">
          <p class="text-sm sm:text-base text-blue-800">
            <span class="font-medium">You need:</span>
            <span class="font-bold">‚Çπ{{ totalEstimatedCost }}</span>
            <span
              *ngIf="totalEstimatedCost === 0"
              class="text-xs text-red-500 block mt-1"
            >
              (Please complete the cost estimation level first)
            </span>
          </p>
        </div>

        <div
          class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6"
        >
          <div
            *ngFor="let source of fundingSources"
            class="funding-option cursor-pointer transition-all duration-200 hover:shadow-md"
            [class.selected]="source.isSelected"
            (click)="toggleFundingSource(source)"
          >
            <div
              class="border-2 rounded-xl p-3 sm:p-4"
              [ngClass]="{
                'border-blue-500 bg-blue-50': source.isSelected,
                'border-gray-200 bg-white hover:border-gray-300':
                  !source.isSelected,
              }"
            >
              <div class="flex items-start space-x-2 sm:space-x-3 mb-2 sm:mb-3">
                <span class="text-2xl sm:text-3xl">{{ source.icon }}</span>
                <div class="flex-1 min-w-0">
                  <h4 class="font-bold text-gray-800 text-sm sm:text-base">
                    {{ source.name }}
                  </h4>
                  <p class="text-xs sm:text-sm text-gray-600 break-words">
                    {{ source.description }}
                  </p>
                </div>
              </div>

              <!-- Amount Input -->
              <div
                *ngIf="source.isSelected && source.maxAmount! > 0"
                class="mt-2 sm:mt-3"
              >
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 mb-1"
                >
                  Amount (Max: ‚Çπ{{ source.maxAmount }}):
                </label>
                <input
                  type="number"
                  [(ngModel)]="source.amount"
                  [max]="source.maxAmount || 0"
                  placeholder="0"
                  class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Funding Summary -->
        <div class="bg-gray-50 rounded-lg p-3 sm:p-4">
          <h4 class="font-bold text-gray-800 mb-2 text-sm sm:text-base">
            Funding Summary:
          </h4>
          <div class="space-y-1 text-xs sm:text-sm">
            <div
              *ngFor="let source of getSelectedFundingSources()"
              class="flex justify-between"
            >
              <span class="truncate pr-2">{{ source.name }}</span>
              <span class="font-medium">‚Çπ{{ source.amount || 0 }}</span>
            </div>
            <div class="border-t pt-2 mt-2 flex justify-between font-bold">
              <span>Total Available:</span>
              <span class="text-green-600">‚Çπ{{ getTotalFunding() }}</span>
            </div>

            <!-- Added comparison with estimated cost -->
            <div *ngIf="totalEstimatedCost > 0" class="border-t pt-2 mt-2">
              <div class="flex justify-between font-bold">
                <span>Total Needed:</span>
                <span class="text-blue-600">‚Çπ{{ totalEstimatedCost }}</span>
              </div>
              <div class="mt-2 text-right">
                <span
                  [ngClass]="{
                    'text-red-500': getTotalFunding() < totalEstimatedCost,
                    'text-green-500': getTotalFunding() >= totalEstimatedCost,
                  }"
                  class="text-xs font-medium"
                >
                  <span *ngIf="getTotalFunding() < totalEstimatedCost">
                    <span class="mr-1">‚ö†Ô∏è</span> You need ‚Çπ{{
                      totalEstimatedCost - getTotalFunding()
                    }}
                    more!
                  </span>
                  <span *ngIf="getTotalFunding() >= totalEstimatedCost">
                    <span class="mr-1">‚úÖ</span> You have enough funding!
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Validation Message for Estimation Game -->
    <div
      *ngIf="
        currentLevel.type === 'estimation' && !gameSubmitted && !canSubmitGame()
      "
      class="mb-4 sm:mb-6 p-3 sm:p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-center max-w-md mx-auto"
    >
      <div class="flex items-center justify-center mb-2">
        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
        <span class="font-medium text-yellow-800 text-sm sm:text-base">
          Please enter positive values for all items
        </span>
      </div>
      <p class="text-xs sm:text-sm text-yellow-700">
        You need to estimate the cost for every item with values greater than
        zero to continue.
      </p>
    </div>

    <!-- Validation Message for Funding Game -->
    <div
      *ngIf="
        currentLevel.type === 'funding' &&
        !gameSubmitted &&
        !canSubmitGame() &&
        totalEstimatedCost > 0
      "
      class="mb-4 sm:mb-6 p-3 sm:p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-center max-w-md mx-auto"
    >
      <div class="flex items-center justify-center mb-2">
        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
        <span class="font-medium text-yellow-800 text-sm sm:text-base">
          You need more funding!
        </span>
      </div>
      <p class="text-xs sm:text-sm text-yellow-700">
        Select funding sources and enter amounts to reach the total amount
        needed (‚Çπ{{ totalEstimatedCost }}).
      </p>
    </div>

    <!-- Validation Message for Selection Game -->
    <div
      *ngIf="
        currentLevel.type === 'selection' && !gameSubmitted && !canSubmitGame()
      "
      class="mb-4 sm:mb-6 p-3 sm:p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-center max-w-md mx-auto"
    >
      <div class="flex items-center justify-center mb-2">
        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
        <span class="font-medium text-yellow-800 text-sm sm:text-base">
          Please guess at least 2 items
        </span>
      </div>
      <p class="text-xs sm:text-sm text-yellow-700">
        You need to guess a minimum of 2 items for your lemonade stand to
        continue. What do you think will be needed?
      </p>
    </div>

    <!-- Celebration Message - Moved above the action buttons -->
    <div
      *ngIf="gameSubmitted"
      class="mb-4 sm:mb-6 bg-green-50 border border-green-200 rounded-xl p-3 sm:p-4 text-center"
    >
      <div class="flex justify-center items-center gap-2 mb-1">
        <div class="text-2xl sm:text-3xl">üéâ</div>
        <h3 class="text-lg font-bold text-green-800">Amazing Work!</h3>
      </div>
      <p class="text-sm text-green-700">You earned 3 stars!</p>
      <div class="flex justify-center space-x-1 my-1">
        <span
          *ngFor="let star of [1, 2, 3]"
          class="text-yellow-400 text-lg sm:text-xl"
          >‚≠ê</span
        >
      </div>
    </div>

    <!-- Action Buttons -->
    <div
      class="text-center space-y-3 sm:space-y-0 sm:space-x-4 flex flex-col sm:flex-row justify-center"
    >
      <button
        *ngIf="!gameSubmitted"
        (click)="handleSubmit()"
        [disabled]="!canSubmitGame()"
        class="font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 text-base sm:text-lg w-full sm:w-auto"
        [ngClass]="{
          'bg-blue-500 hover:bg-blue-600 text-white hover:shadow-lg':
            canSubmitGame(),
          'bg-gray-300 text-gray-500 cursor-not-allowed': !canSubmitGame(),
        }"
      >
        {{ getSubmitButtonText() }}
      </button>

      <button
        *ngIf="
          !gameSubmitted && !showHints && currentLevel.gameData.hints?.length
        "
        (click)="showHints = true"
        class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 hover:shadow-lg text-base sm:text-lg w-full sm:w-auto"
      >
        üí° Show Hints
      </button>

      <button
        *ngIf="gameSubmitted"
        (click)="nextLevel()"
        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 hover:shadow-lg text-base sm:text-lg w-full sm:w-auto animate-bounce"
      >
        {{ isLastLevel ? "Complete Lesson" : "Next Level" }} ‚Üí
      </button>
    </div>
  </div>
</div>
