<div
  class="min-h-screen bg-gradient-to-br from-yellow-100 via-orange-50 to-red-100"
  *ngIf="currentLevel()"
>
  <!-- Header -->
  <div class="bg-white shadow-sm border-b-4 border-yellow-400 p-3 sm:p-4">
    <div
      class="max-w-4xl mx-auto flex items-center justify-between flex-wrap gap-2"
    >
      <div class="flex items-center space-x-3 sm:space-x-4 flex-1 min-w-0">
        <button
          (click)="goBack()"
          class="text-gray-600 hover:text-gray-800 text-xl sm:text-2xl flex-shrink-0"
        >
          ‚Üê Back
        </button>
        <div class="min-w-0 flex-1">
          <h1 class="text-lg sm:text-xl font-bold text-gray-800 truncate">
            {{ currentLevel()?.title }}
          </h1>
          <p class="text-xs sm:text-sm text-gray-600 line-clamp-2">
            {{ currentLevel()?.description }}
          </p>
        </div>
      </div>
      <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
        <span
          *ngFor="let star of getStarsArray(currentLevel()?.stars || 0)"
          class="text-yellow-400 text-lg sm:text-xl"
          >‚≠ê</span
        >
      </div>
    </div>
  </div>

  <!-- Game Content -->
  <div class="max-w-4xl mx-auto p-3 sm:p-4 md:p-6">
    <!-- Scene Description -->
    <div
      *ngIf="currentLevel()?.gameData?.scene"
      class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 text-center"
    >
      <div class="text-4xl sm:text-5xl md:text-6xl mb-3 sm:mb-4">üè™</div>
      <p class="text-base sm:text-lg text-gray-700">
        {{ currentLevel()?.gameData?.scene }}
      </p>
    </div>

    <!-- Game Prompt -->
    <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
      <h2
        class="text-xl sm:text-2xl font-bold text-center text-gray-800 mb-3 sm:mb-4"
      >
        {{ currentLevel()?.gameData?.prompt }}
      </h2>

      <!-- Hints -->
      <div
        *ngIf="showHints() && currentLevel()?.gameData?.hints"
        class="bg-blue-50 border-l-4 border-blue-400 p-3 sm:p-4 mb-3 sm:mb-4"
      >
        <div class="flex items-center mb-2">
          <span class="text-blue-600 mr-2">üí°</span>
          <span class="font-medium text-blue-800 text-sm sm:text-base"
            >Hints:</span
          >
        </div>
        <ul class="text-blue-700 text-xs sm:text-sm space-y-1">
          <li *ngFor="let hint of currentLevel()?.gameData?.hints">
            ‚Ä¢ {{ hint }}
          </li>
        </ul>
      </div>
    </div>

    <!-- Selection Game (Level 1) -->
    <div *ngIf="currentLevel()?.type === 'selection'" class="game-content">
      <app-selection-game
        [gameItems]="gameItems()"
        [isSubmitted]="gameSubmitted()"
        (itemClick)="toggleItemSelection($event)"
      ></app-selection-game>
    </div>

    <!-- Estimation Game (Level 2) -->
    <div *ngIf="currentLevel()?.type === 'estimation'" class="game-content">
      <app-estimation-game
        [estimationFields]="estimationFields()"
        [isSubmitted]="gameSubmitted()"
        (valueChange)="onEstimationChange()"
      ></app-estimation-game>
    </div>

    <!-- Funding Game (Level 3) -->
    <div *ngIf="currentLevel()?.type === 'funding'" class="game-content">
      <app-funding-game
        [fundingSources]="fundingSources()"
        [totalEstimatedCost]="totalEstimatedCost()"
        [isSubmitted]="gameSubmitted()"
        (sourceClick)="toggleFundingSource($event)"
        (amountChange)="onFundingChange()"
      ></app-funding-game>
    </div>

    <!-- Validation Message for Estimation Game -->
    <div
      *ngIf="
        currentLevel()?.type === 'estimation' &&
        !gameSubmitted() &&
        !canSubmitGame()
      "
      class="mb-4 sm:mb-6 p-3 sm:p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-center max-w-md mx-auto"
    >
      <div class="flex items-center justify-center mb-2">
        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
        <span class="font-medium text-yellow-800 text-sm sm:text-base">
          Please enter positive values for all items
        </span>
      </div>
      <p class="text-xs sm:text-sm text-yellow-700">
        You need to estimate the cost for every item with values greater than
        zero to continue.
      </p>
    </div>

    <!-- Validation Message for Funding Game -->
    <div
      *ngIf="
        currentLevel()?.type === 'funding' &&
        !gameSubmitted() &&
        !canSubmitGame() &&
        totalEstimatedCost() > 0
      "
      class="mb-4 sm:mb-6 p-3 sm:p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-center max-w-md mx-auto"
    >
      <div class="flex items-center justify-center mb-2">
        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
        <span class="font-medium text-yellow-800 text-sm sm:text-base">
          You need more funding!
        </span>
      </div>
      <p class="text-xs sm:text-sm text-yellow-700">
        Select funding sources and enter amounts to reach the total amount
        needed (‚Çπ{{ totalEstimatedCost() }}).
      </p>
    </div>

    <!-- Validation Message for Selection Game -->
    <div
      *ngIf="
        currentLevel()?.type === 'selection' &&
        !gameSubmitted() &&
        !canSubmitGame()
      "
      class="mb-4 sm:mb-6 p-3 sm:p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-center max-w-md mx-auto"
    >
      <div class="flex items-center justify-center mb-2">
        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
        <span class="font-medium text-yellow-800 text-sm sm:text-base">
          Please guess at least 2 items
        </span>
      </div>
      <p class="text-xs sm:text-sm text-yellow-700">
        You need to guess a minimum of 2 items for your lemonade stand to
        continue. What do you think will be needed?
      </p>
    </div>

    <!-- Celebration Message - Moved above the action buttons -->
    <div
      *ngIf="gameSubmitted()"
      class="mb-4 sm:mb-6 bg-green-50 border border-green-200 rounded-xl p-3 sm:p-4 text-center"
    >
      <div class="flex justify-center items-center gap-2 mb-1">
        <div class="text-2xl sm:text-3xl">üéâ</div>
        <h3 class="text-lg font-bold text-green-800">Amazing Work!</h3>
      </div>
      <p class="text-sm text-green-700">You earned 3 stars!</p>
      <div class="flex justify-center space-x-1 my-1">
        <span
          *ngFor="let star of [1, 2, 3]"
          class="text-yellow-400 text-lg sm:text-xl"
          >‚≠ê</span
        >
      </div>
    </div>

    <!-- Action Buttons -->
    <div
      class="text-center space-y-3 sm:space-y-0 sm:space-x-4 flex flex-col sm:flex-row justify-center"
    >
      <button
        *ngIf="!gameSubmitted()"
        (click)="handleSubmit()"
        [disabled]="!canSubmitGame()"
        class="font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 text-base sm:text-lg w-full sm:w-auto"
        [ngClass]="{
          'bg-blue-500 hover:bg-blue-600 text-white hover:shadow-lg':
            canSubmitGame(),
          'bg-gray-300 text-gray-500 cursor-not-allowed': !canSubmitGame(),
        }"
      >
        {{ getSubmitButtonText() }}
      </button>

      <button
        *ngIf="
          !gameSubmitted() &&
          !showHints() &&
          currentLevel()?.gameData?.hints?.length
        "
        (click)="showHints.set(true)"
        class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 hover:shadow-lg text-base sm:text-lg w-full sm:w-auto"
      >
        üí° Show Hints
      </button>

      <button
        *ngIf="gameSubmitted()"
        (click)="nextLevel()"
        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 sm:py-3 px-6 sm:px-8 rounded-xl transition-all duration-200 hover:shadow-lg text-base sm:text-lg w-full sm:w-auto animate-bounce"
      >
        {{ isLastLevel() ? "Complete Lesson" : "Next Level" }} ‚Üí
      </button>
    </div>
  </div>
</div>
